<!DOCTYPE html>
<html>
<head>
  <title>RSVP System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .secondary-btn {
      background-color: #6c757d;
    }
    .secondary-btn:hover {
      background-color: #545b62;
    }
    .danger-btn {
      background-color: #dc3545;
    }
    .danger-btn:hover {
      background-color: #c82333;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .event-info {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .event-info h2 {
      margin-top: 0;
      color: #495057;
    }
    #result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .tab-buttons {
      margin-bottom: 20px;
    }
    .tab-button {
      background-color: #f8f9fa;
      color: #495057;
      border: 1px solid #ddd;
      padding: 8px 16px;
      margin-right: 5px;
    }
    .tab-button.active {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Page -->
    <div id="loginPage" class="page active">
      <h1>RSVP System</h1>
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('user')">User Registration</button>
        <button class="tab-button" onclick="showTab('admin')">Admin Login</button>
      </div>

      <div id="userTab" class="tab-content">
        <div class="event-info">
          <h2 id="eventTitle">Second Education Session 2025</h2>
          <p><strong>Starting:</strong> <span id="starting">بِسْمِ ٱللهِ ٱلرَّحْمَٰنِ ٱلرَّحِيْمِ</span></p>
          <p><strong>Date:</strong> <span id="eventDate">14th September, Sunday</span></p>
          <p><strong>Venue:</strong> <span id="eventVenue">MSF, Address: 2187 Fellowship Rd, Tucker, GA 30084</span></p>
          <p><strong>Organized by:</strong> <span id="eventOrganizer">Event Committee</span></p>
        </div>

        <form id="rsvpForm">
          <div class="form-group">
            <input type="text" name="First_name" id="a" placeholder="First Name" required>
          </div>
          <div class="form-group">
            <input type="text" name="Last_name" id="b" placeholder="Last Name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Sub-Chapter Name</label>
            <select class="form-select" name="subChapter" id="c" required>
              <option value="">Select Sub-Chapter</option>
              <option value="Doraville Male Sub-Chapter">Doraville Male Sub-Chapter</option>
              <option value="Lilburn Male Sub-Chapter">Lilburn Male Sub-Chapter</option>
              <option value="Lawrenceville Male Sub-Chapter">Lawrenceville Male Sub-Chapter</option>
              <option value="MSF Male Sub-Chapter">MSF Male Sub-Chapter</option>
              <option value="Norcross Male Sub-Chapter">Norcross Male Sub-Chapter</option>
              <option value="Athens Male Sub-Chapter">Athens Male Sub-Chapter</option>
              <option value="Chamblee Male Sub-Chapter">Chamblee Male Sub-Chapter</option>
              <option value="Chamblee Female Sub-Chapter">Chamblee Female Sub-Chapter</option>
              <option value="Lilburn Female Sub-Chapter">Lilburn Female Sub-Chapter</option>
              <option value="Norcross Female Sub-Chapter">Norcross Female Sub-Chapter</option>
              <option value="MSF Female Sub-Chapter">MSF Female Sub-Chapter</option>
              <option value="Lawrenceville Female Sub-Chapter">Lawrenceville Female Sub-Chapter</option>
              <option value="Athens Female Sub-Chapter">Athens Female Sub-Chapter</option>
              <option value="Doraville Female Sub-Chapter">Doraville Female Sub-Chapter</option>
              <option value="Stone Mountain Female Sub-Chapter">Stone Mountain Female Sub-Chapter</option>
              <option value="Young Sister GA Sub-Chapter">Young Sister GA Sub-Chapter</option>
              <option value="MUNA Youth Junior GA">MUNA Youth Junior GA</option>
              <option value="MUNA Youth GA Sub-Chapter">MUNA Youth GA Sub-Chapter</option>
              <option value="Madina Institute Male SC">Madina Institute Male SC</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <input type="number" name="Adult_Count" id="d" placeholder="Adult Count" min="0" required>
          </div>
          <div class="form-group">
            <input type="number" name="Kids_Count" id="e" placeholder="Kids Count" min="0" required>
          </div>
          <div class="form-group">
            <label class="form-label">Will you attend?</label>
            <select name="response" id="f" required>
              <option value="">Select Response</option>
              <option value="Yes">Yes, In Sha Allah</option>
              <option value="No">No, Unable to attend this time</option>
            </select>
          </div>
          <button type="submit">Submit RSVP</button>
        </form>
        <div id="result"></div>
      </div>

      <div id="adminTab" class="tab-content" style="display: none;">
        <h2>Admin Login</h2>
        <form id="adminLoginForm">
          <div class="form-group">
            <input type="password" id="adminPassword" placeholder="Admin Password" required>
          </div>
          <button type="submit">Login</button>
        </form>
        <div id="loginResult"></div>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="page">
      <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <button class="danger-btn" onclick="logout()">Logout</button>
      </div>

      <div class="tab-buttons">
        <button class="tab-button active" onclick="showAdminTab('stats')">Statistics</button>
        <button class="tab-button" onclick="showAdminTab('settings')">Event Settings</button>
      </div>

      <div id="statsTab" class="tab-content">
        <h2>RSVP Statistics</h2>
        <button onclick="loadStats()" class="secondary-btn">Refresh Statistics</button>
        <div id="statsContainer">
          <p>Click "Refresh Statistics" to load data</p>
        </div>
      </div>

      <div id="settingsTab" class="tab-content" style="display: none;">
        <h2>Event Settings</h2>
        <form id="eventSettingsForm">
          <div class="form-group">
            <label class="form-label">Event Title</label>
            <input type="text" id="settingsTitle" required>
          </div>
          <div class="form-group">
            <label class="form-label">Event Date</label>
            <input type="text" id="settingsDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Venue</label>
            <input type="text" id="settingsVenue" required>
          </div>
          <div class="form-group">
            <label class="form-label">Organized By</label>
            <input type="text" id="settingsOrganizer" required>
          </div>
          <button type="submit">Update Event Details</button>
        </form>
        <div id="settingsResult"></div>
      </div>
    </div>
  </div>

  <script>
    // Admin password - change this to your desired password
    const ADMIN_PASSWORD = "munaga0513";

    // Event data stored in memory (you can enhance this to sync with Google Sheets)
    let eventData = {
      title: "Education Session 2025",
      date: "14th September, Sunday",
      venue: "TBA",
      organizer: "Event Committee"
    };

    // Tab switching for login page
    function showTab(tabName) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

      if (tabName === 'user') {
        document.querySelector('.tab-button').classList.add('active');
        document.getElementById('userTab').style.display = 'block';
      } else {
        document.querySelectorAll('.tab-button')[1].classList.add('active');
        document.getElementById('adminTab').style.display = 'block';
      }
    }

    // Tab switching for admin dashboard
    function showAdminTab(tabName) {
      document.querySelectorAll('#adminPage .tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#adminPage .tab-content').forEach(content => content.style.display = 'none');

      if (tabName === 'stats') {
        document.querySelectorAll('#adminPage .tab-button')[0].classList.add('active');
        document.getElementById('statsTab').style.display = 'block';
      } else {
        document.querySelectorAll('#adminPage .tab-button')[1].classList.add('active');
        document.getElementById('settingsTab').style.display = 'block';
        loadEventSettings();
      }
    }

    // Show specific page
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    // Admin login
    document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
      const resultDiv = document.getElementById('loginResult');

      if (password === ADMIN_PASSWORD) {
        showPage('adminPage');
        resultDiv.innerHTML = '';
      } else {
        resultDiv.innerHTML = '<div class="error">Invalid password</div>';
      }
    });

    // Logout
    function logout() {
      showPage('loginPage');
      document.getElementById('adminPassword').value = '';
      document.getElementById('loginResult').innerHTML = '';
    }

    // Load event settings into form
    function loadEventSettings() {
      document.getElementById('settingsTitle').value = eventData.title;
      document.getElementById('settingsDate').value = eventData.date;
      document.getElementById('settingsVenue').value = eventData.venue;
      document.getElementById('settingsOrganizer').value = eventData.organizer;
    }

    // Update event settings
    document.getElementById('eventSettingsForm').addEventListener('submit', function(e) {
      e.preventDefault();

      eventData.title = document.getElementById('settingsTitle').value;
      eventData.date = document.getElementById('settingsDate').value;
      eventData.venue = document.getElementById('settingsVenue').value;
      eventData.organizer = document.getElementById('settingsOrganizer').value;

      // Update the display on user page
      document.getElementById('eventTitle').textContent = eventData.title;
      document.getElementById('eventDate').textContent = eventData.date;
      document.getElementById('eventVenue').textContent = eventData.venue;
      document.getElementById('eventOrganizer').textContent = eventData.organizer;

      document.getElementById('settingsResult').innerHTML = '<div class="success">Event details updated successfully!</div>';

      setTimeout(() => {
        document.getElementById('settingsResult').innerHTML = '';
      }, 3000);
    });

    // Original RSVP form submission
    const form = document.getElementById('rsvpForm');
    form.addEventListener("submit", e => {
      e.preventDefault();

      const data = {
        First_name: document.getElementById("a").value,
        Last_name: document.getElementById("b").value,
        Subchapter_name: document.getElementById("c").value,
        response: document.getElementById("f").value,
        Adult_Count: document.getElementById("d").value,
        Kids_Count: document.getElementById("e").value
      };

      fetch("https://script.google.com/macros/s/AKfycbzE8gbxQ_fuH2XvUglXHMJy5whLD8EZ8dmK2iEeS7nzgmqeHns-RUMC_ZvegsOxG9Z8/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(() => {
        document.getElementById('result').innerHTML = '<div class="success">RSVP submitted successfully!</div>';
        form.reset();
      })
      .catch(() => {
        document.getElementById('result').innerHTML = '<div class="error">Error submitting RSVP. Please try again.</div>';
      });
    });

    // Load statistics using JSONP to bypass CORS
    function loadStats() {
      document.getElementById('statsContainer').innerHTML = '<p>Loading statistics...</p>';

      // Create a unique callback name
      const callbackName = 'statsCallback_' + Date.now();

      // Create the callback function
      window[callbackName] = function(data) {
        try {
          if (data && data.result === 'success') {
            displayStats(data.data);
          } else {
            document.getElementById('statsContainer').innerHTML =
              '<div class="error">Error loading statistics: ' + (data.message || 'Unknown error') + '</div>';
          }
        } catch (err) {
          document.getElementById('statsContainer').innerHTML =
            '<div class="error">Error processing statistics data</div>';
        }

        // Clean up
        if (script && script.parentNode) {
          document.head.removeChild(script);
        }
        delete window[callbackName];
      };

      // Create script tag for JSONP - using the same URL as RSVP submissions
      const script = document.createElement('script');
      script.src = `https://script.google.com/macros/s/AKfycbzE8gbxQ_fuH2XvUglXHMJy5whLD8EZ8dmK2iEeS7nzgmqeHns-RUMC_ZvegsOxG9Z8/exec?action=getStats&callback=${callbackName}`;

      // Handle script loading errors
      script.onerror = function() {
        document.getElementById('statsContainer').innerHTML = `
          <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4>Statistics Loading Issue</h4>
            <p>Unable to load live statistics. This could be due to:</p>
            <ul>
              <li>Google Apps Script deployment settings</li>
              <li>Browser security restrictions</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <ol>
              <li>Make sure your Google Apps Script is deployed as a web app with "Anyone" access</li>
              <li>Try this direct link: <a href="https://script.google.com/macros/s/AKfycbzE8gbxQ_fuH2XvUglXHMJy5whLD8EZ8dmK2iEeS7nzgmqeHns-RUMC_ZvegsOxG9Z8/exec?action=getStats" target="_blank">View Statistics</a></li>
            </ol>
            <p><em>Note: RSVP submissions are still working perfectly!</em></p>
          </div>
        `;

        if (script && script.parentNode) {
          document.head.removeChild(script);
        }
        delete window[callbackName];
      };

      // Add timeout
      setTimeout(() => {
        if (window[callbackName]) {
          script.onerror();
        }
      }, 10000);

      document.head.appendChild(script);
    }

    function displayStats(stats) {
      let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Responses</h3>
            <div class="stat-number">${stats.totalResponses}</div>
          </div>
          <div class="stat-card">
            <h3>Attending (Yes)</h3>
            <div class="stat-number" style="color: #28a745;">${stats.yesResponses}</div>
          </div>
          <div class="stat-card">
            <h3>Not Attending (No)</h3>
            <div class="stat-number" style="color: #dc3545;">${stats.noResponses}</div>
          </div>
          <div class="stat-card">
            <h3>Total Adults</h3>
            <div class="stat-number">${stats.totalAdults}</div>
          </div>
          <div class="stat-card">
            <h3>Total Kids</h3>
            <div class="stat-number">${stats.totalKids}</div>
          </div>
        </div>

        <h3 style="margin-top: 30px;">Sub-Chapter Breakdown</h3>
        <div class="stats-grid">
      `;

      Object.entries(stats.subchapterStats).forEach(([subchapter, data]) => {
        html += `
          <div class="stat-card">
            <h4>${subchapter}</h4>
            <p><strong>Yes:</strong> ${data.yes} | <strong>No:</strong> ${data.no}</p>
            <p><strong>Adults:</strong> ${data.adults} | <strong>Kids:</strong> ${data.kids}</p>
            <p><strong>Total People:</strong> ${data.adults + data.kids}</p>
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('statsContainer').innerHTML = html;
    }

    // Initialize with current event data
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('eventTitle').textContent = eventData.title;
      document.getElementById('eventDate').textContent = eventData.date;
      document.getElementById('eventVenue').textContent = eventData.venue;
      document.getElementById('eventOrganizer').textContent = eventData.organizer;
    });
  </script>
</body>
</html>
